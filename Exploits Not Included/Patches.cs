using HarmonyLib;
using UnityEngine;

namespace Exploits_Not_Included
{
    public class Patches
    {
    
        /// <summary>
        /// Allows Duplicants wearing suit tank equipment with no oxygen to correctly interact with the atmosphere when performing the Recover Breath chore.
        /// Includes Atmo/Lead/Jet suit and oxygen mask.
        /// </summary>
        [HarmonyPatch(typeof(GasBreatherFromWorldProvider), nameof(GasBreatherFromWorldProvider.IsBlocked))]
        public class GasBreatherFromWorldProvider_IsBlocked_Patch
        {
            public static void Postfix(ref bool __result, OxygenBreather ___oxygenBreather)
            {                
                __result = ___oxygenBreather.HasTag(GameTags.HasSuitTank) && !___oxygenBreather.HasTag(GameTags.RecoveringBreath);
            }
        }

        /// <summary>
        /// Prevent pips from planting in a buried flower pot to prevent the copy settings semi wild plant bug.
        /// </summary>
        [HarmonyPatch(typeof(PlantableCellQuery), "CheckValidPlotCell")]
        public class PlantableCellQuery_CheckValidPlotCell_Patch
        {
            public static void Postfix(PlantableSeed seed, int plant_cell, ref bool __result)
            {
                int cell = seed.direction == SingleEntityReceptacle.ReceptacleDirection.Top ? Grid.CellBelow(plant_cell) : Grid.CellAbove(plant_cell);
                GameObject gameObject = Grid.Objects[cell, (int)ObjectLayer.Building];                
                if (gameObject != null && gameObject.TryGetComponent(out PlantablePlot plot) && plot.HasTag(GameTags.Entombed))
                    __result = false;                                    
            }
        }
        
        /// <summary>
        /// Requires a seed to be whole to be picked up. Prevents splitting a seed by taking a fraction to a storage with (0,1000) grams of free space.
        /// Side effect: If a fraction of a seed already exists by some other method, it can not be picked up or moved.
        /// ToDo: Lookup other seed splitting methods.
        /// Setting this value to 1 for seeds on spawn or prefab or some such would likely be better but this is a property with no setter and I don't know how to get around that.
        /// This is called very frequently.
        /// </summary>
        [HarmonyPatch(typeof(Pickupable), nameof(Pickupable.MinTakeAmount), MethodType.Getter)]
        public class Pickupable_MinTakeAmount_Getter_Patch
        {
            public static void Postfix(Pickupable __instance, ref float __result)
            {                
                if (__instance.HasTag(GameTags.Seed))
                    __result = 1f;
            }
        }
                

    }
}
